<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel LAN Center</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- ‚úÖ HEADER ULTRA PREMIUM -->
<div class="header-premium">

  <div class="top-logo">
    <img src="logo.png" class="logo">
  </div>

  <h1 class="titulo">PANEL LAN CENTER JACKNNIEL</h1>

  <h2 id="rolTexto" class="rol"></h2>

</div>

<!-- üîê ADMIN INFO -->
<div id="adminPanel" class="admin-box" style="display:none;">
  <h2>üîê Admin: Subir QR desde GitHub</h2>

  <p>Para cambiar un QR solo reemplaza estos archivos:</p>

  <div class="files">
    <span>‚úÖ qr_banco.png</span>
    <span>‚úÖ qr_yasta.png</span>
  </div>

  <a class="btn-repo"
     href="https://github.com/lancenterjacknniel/panel-jacknniel"
     target="_blank">
     üëâ Ir al Repo y subir QR
  </a>
</div>

<hr>

<!-- ‚úÖ MEN√ö PRINCIPAL PREMIUM -->
<div class="menu-botones">
  <button class="btn" onclick="mostrarPagos()">üí≥ M√©todos de Pago</button>
  <button class="btn" onclick="mostrarPrecios()">üí∞ Precios</button>
</div>

<br>

<!-- ‚úÖ PANEL M√âTODOS DE PAGO (AUTOM√ÅTICO DESDE pagos.txt) -->
<div id="pagosPanel" class="panel-seccion" style="display:none;">

  <h2 class="subtitulo">üí≥ M√âTODOS DE PAGO</h2>

  <div id="listaPagos">
    ‚è≥ Cargando m√©todos...
  </div>

</div>

<!-- ‚úÖ PANEL PRECIOS -->
<div id="preciosPanel" class="panel-seccion" style="display:none;">

  <h2 class="subtitulo">üí∞ Cat√°logo de Precios</h2>
  <p class="mini">üìå Busca o toca una categor√≠a para desplegar</p>

  <!-- üîç BUSCADOR -->
  <input
    type="text"
    id="buscadorPrecios"
    class="buscador"
    placeholder="üîç Buscar Free Fire, Netflix, Pase..."
    onkeyup="filtrarPrecios()"
  >

  <div id="listaPrecios">
    ‚è≥ Cargando precios...
  </div>

</div>

<br>

<!-- ‚úÖ BOT√ìN SALIR -->
<button class="btn-salir" onclick="logout()">Salir</button>

<script>

  // üîí BLOQUEO TOTAL
  let user = localStorage.getItem("user");
  if (!user) window.location.href = "login.html";

  let rol = localStorage.getItem("rol");

  document.getElementById("rolTexto").innerText =
    "Usuario: " + user + " | Rol: " + rol;

  if (rol === "admin") {
    document.getElementById("adminPanel").style.display = "block";
  }

  // Mostrar/Ocultar Pagos
  function mostrarPagos() {
    let panel = document.getElementById("pagosPanel");

    if (panel.style.display === "none") {
      panel.style.display = "block";
      cargarPagos();
    } else {
      panel.style.display = "none";
    }
  }

  // Mostrar/Ocultar Precios
  function mostrarPrecios() {
    let panel = document.getElementById("preciosPanel");

    if (panel.style.display === "none") {
      panel.style.display = "block";
      cargarPrecios();
      document.getElementById("buscadorPrecios").value = "";
    } else {
      panel.style.display = "none";
    }
  }

  // ‚úÖ CARGAR PAGOS DESDE pagos.txt
  async function cargarPagos() {

    let contenedor = document.getElementById("listaPagos");

    try {

      const res = await fetch("pagos.txt?v=" + new Date().getTime());
      const texto = await res.text();

      let partes = texto.split("###");
      let html = "";

      for (let i = 1; i < partes.length; i += 2) {

        let categoria = partes[i].trim();
        let contenido = partes[i + 1].trim();

        html += `<h2 class="subtitulo">üí≥ ${categoria}</h2>`;
        html += `<div class="grid">`;

        let lineas = contenido.split("\n");

        lineas.forEach((linea) => {

          if (!linea.includes("|")) return;

          let datos = linea.split("|");
          let nombre = datos[0].trim();
          let archivoQR = datos[1].trim();

          let idImg = "qr-" + nombre.replaceAll(" ", "");

          html += `
            <div class="card-pro">
              <h2>${nombre}</h2>

              <img id="${idImg}"
                   class="qr-img"
                   src="${archivoQR}"
                   onclick="zoomQR('${idImg}')">

              <div class="botones-qr">

                <button class="btn-copy"
                        onclick="copiarQR('${idImg}')">
                  üìã Copiar
                </button>

                <button class="btn-download"
                        onclick="descargarQR('${archivoQR}','${nombre}')">
                  ‚¨á Descargar
                </button>

              </div>
            </div>
          `;
        });

        html += `</div>`;
      }

      contenedor.innerHTML = html;

    } catch (error) {
      contenedor.innerHTML =
        "<p style='color:red;'>‚ùå No se pudieron cargar los pagos</p>";
    }
  }

  // ‚úÖ CARGAR PRECIOS
  async function cargarPrecios() {

    let contenedor = document.getElementById("listaPrecios");

    try {

      const res = await fetch("precios.txt?v=" + new Date().getTime());
      const texto = await res.text();

      let partes = texto.split("###");
      let html = "";

      for (let i = 1; i < partes.length; i += 2) {

        let categoria = partes[i].trim();
        let bloque = partes[i + 1].trim();

        let visible = bloque.replaceAll("\n", "<br>");

        html += `
          <div class="categoria">

            <button class="btn-categoria"
              onclick="toggleCategoria('${categoria}')">
              ‚ñ∂ ${categoria}
            </button>

            <div class="contenido" id="cat-${categoria}">
              <div class="bloque-precio">
                <div class="texto-precio">${visible}</div>

                <button class="btn-copiar-todo"
                  onclick="copiarBloque(event,\`${bloque}\`)">
                  üìã Copiar Todo
                </button>
              </div>
            </div>

          </div>
        `;
      }

      contenedor.innerHTML = html;

    } catch (error) {
      contenedor.innerHTML =
        "<p style='color:red;'>‚ùå No se pudieron cargar los precios</p>";
    }
  }

  // Slide categor√≠as
  function toggleCategoria(cat) {

    let div = document.getElementById("cat-" + cat);

    if (div.classList.contains("abierto")) {
      div.classList.remove("abierto");
      div.style.maxHeight = "0px";
      return;
    }

    document.querySelectorAll(".contenido").forEach((caja) => {
      caja.classList.remove("abierto");
      caja.style.maxHeight = "0px";
    });

    div.classList.add("abierto");
    div.style.maxHeight = div.scrollHeight + "px";
  }

  // Buscador precios
  function filtrarPrecios() {

    let input = document.getElementById("buscadorPrecios").value.toLowerCase();

    document.querySelectorAll(".categoria").forEach((cat) => {

      let texto = cat.innerText.toLowerCase();
      let contenido = cat.querySelector(".contenido");

      if (input.trim() === "") {
        cat.style.display = "block";
        contenido.style.maxHeight = "0px";
        contenido.classList.remove("abierto");
        return;
      }

      if (texto.includes(input)) {
        cat.style.display = "block";
        contenido.classList.add("abierto");
        contenido.style.maxHeight = contenido.scrollHeight + "px";
      } else {
        cat.style.display = "none";
      }
    });
  }

  // Copiar bloque
  function copiarBloque(event, texto) {
    event.stopPropagation();
    navigator.clipboard.writeText(texto);
    mostrarMensaje("‚úÖ Copiado correctamente");
  }

  // Toast
  function mostrarMensaje(msg) {
    let aviso = document.createElement("div");
    aviso.innerText = msg;
    aviso.className = "toast";
    document.body.appendChild(aviso);
    setTimeout(() => aviso.remove(), 1800);
  }

  // Copiar QR imagen
  async function copiarQR(idImg) {

    let img = document.getElementById(idImg);

    try {
      const response = await fetch(img.src);
      const blob = await response.blob();

      await navigator.clipboard.write([
        new ClipboardItem({ [blob.type]: blob })
      ]);

      mostrarMensaje("‚úÖ QR copiado");

    } catch {
      mostrarMensaje("‚ùå No se pudo copiar");
    }
  }

  // Descargar QR
  function descargarQR(archivo, nombre) {
    let a = document.createElement("a");
    a.href = archivo;
    a.download = nombre + ".png";
    a.click();
  }

  // Zoom
  function zoomQR(idImg) {
    document.getElementById(idImg).classList.toggle("zoom");
  }

  // Logout
  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }

</script>

</body>
</html>
