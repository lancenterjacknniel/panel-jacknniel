<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel LAN Center JACKNNIEL</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h1>üöÄ PANEL LAN CENTER JACKNNIEL</h1>
<h3 id="rolTxt"></h3>

<div class="contenedor">

  <!-- BANCO UNION -->
  <div class="card">
    <h2>Banco Uni√≥n</h2>

    <button onclick="mostrarQR('banco_union')">Mostrar QR</button>

    <div id="qr_banco_union" class="qr-box"></div>

    <!-- SOLO ADMIN -->
    <div class="adminOnly">
      <input id="input_banco_union" placeholder="Pega link Drive Banco Uni√≥n">
      <button onclick="guardarLink('banco_union')">Guardar</button>
    </div>

    <button onclick="copiarQR('banco_union')">üìå Copiar QR</button>

    <button onclick="enviarWhatsApp('banco_union')">
      üì≤ WhatsApp
    </button>
  </div>

  <!-- YASTA -->
  <div class="card">
    <h2>Yasta</h2>

    <button onclick="mostrarQR('yasta')">Mostrar QR</button>

    <div id="qr_yasta" class="qr-box"></div>

    <!-- SOLO ADMIN -->
    <div class="adminOnly">
      <input id="input_yasta" placeholder="Pega link Drive Yasta">
      <button onclick="guardarLink('yasta')">Guardar</button>
    </div>

    <button onclick="copiarQR('yasta')">üìå Copiar QR</button>

    <button onclick="enviarWhatsApp('yasta')">
      üì≤ WhatsApp
    </button>
  </div>

</div>

<br>
<button onclick="cerrarSesion()">üö™ Salir</button>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script src="app.js"></script>

<script>
/* ==============================
   CONFIG ADMIN / OPERADOR
================================ */
const rol = localStorage.getItem("rol");
document.getElementById("rolTxt").innerText = "Rol: " + rol;

if (rol !== "admin") {
  document.querySelectorAll(".adminOnly").forEach(el => el.style.display = "none");
}

/* ==============================
   FIRESTORE QR LINKS
================================ */
const coleccion = db.collection("qr_links");

/* Convertir link Drive a imagen directa */
function convertirDrive(url) {
  if (!url.includes("drive.google.com")) return url;

  let id = url.split("/d/")[1].split("/")[0];
  return `https://drive.google.com/uc?export=view&id=${id}`;
}

/* ==============================
   GUARDAR LINK (ADMIN)
================================ */
async function guardarLink(nombre) {
  const input = document.getElementById("input_" + nombre);
  const url = input.value.trim();

  if (url === "") {
    alert("‚ö†Ô∏è Peg√° un link primero");
    return;
  }

  await coleccion.doc(nombre).set({ url });

  alert("‚úÖ QR guardado correctamente");
}

/* ==============================
   MOSTRAR QR
================================ */
async function mostrarQR(nombre) {

  const doc = await coleccion.doc(nombre).get();

  if (!doc.exists) {
    alert("‚ö†Ô∏è No hay QR cargado todav√≠a");
    return;
  }

  const url = convertirDrive(doc.data().url);

  document.getElementById("qr_" + nombre).innerHTML =
    `<img src="${url}" width="220">`;
}

/* ==============================
   COPIAR QR
================================ */
async function copiarQR(nombre) {

  const doc = await coleccion.doc(nombre).get();
  if (!doc.exists) return alert("No hay QR");

  const url = convertirDrive(doc.data().url);

  navigator.clipboard.writeText(url);

  alert("‚úÖ Link del QR copiado");
}

/* ==============================
   WHATSAPP AUTOMATICO
================================ */
async function enviarWhatsApp(nombre) {

  const doc = await coleccion.doc(nombre).get();
  if (!doc.exists) return alert("No hay QR");

  const url = convertirDrive(doc.data().url);

  let telefono = "60772546";

  let mensaje = `Hola, aqu√≠ est√° el QR de pago:\n${url}`;

  window.open(
    `https://wa.me/591${telefono}?text=${encodeURIComponent(mensaje)}`
  );
}

/* ==============================
   SALIR
================================ */
function cerrarSesion() {
  localStorage.clear();
  window.location = "login.html";
}
</script>

</body>
</html>
